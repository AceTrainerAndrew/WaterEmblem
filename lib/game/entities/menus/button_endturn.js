/** *  button_endturn.js *  ----- */ig.module(    'game.entities.menus.button_endturn').requires(    'plugins.button.button').defines(function() {    'use strict';    ig.global.EntityButton_endturn = ig.Button.extend({        name: 'btn_endturn',        text: ['End Turn'],        pressedUp: function() {            var lastPlayerUnitIndex = 0;            // Set all player's units turn to used            for(var u = 0; u < ig.game.units.length; u++) {                if(ig.game.units[u].unitType === 'player') {                    // NOTES                    // 1. Player starts on some arbitrary tile.                     // 2. Player moves to some tile.                    // 3. Clicks "end" button. We need to apply the terrain bonuses.                     // Step 1. Remove any existing terrain bonuses and clear storage                    ig.game.units[ig.game.activeUnit].stat.def -= ig.game.units[ig.game.activeUnit].terrainMod.def;                    ig.game.units[ig.game.activeUnit].derived_stats.evade -= ig.game.units[ig.game.activeUnit].terrainMod.avoid;                    // Clear our the bonus so we don't keep stacking it in the future                    ig.game.units[ig.game.activeUnit].terrainMod.avoid = 0;                    ig.game.units[ig.game.activeUnit].terrainMod.def = 0;                    // Step 2. Get the current terrain properties                    var activeUnit_terrain = ig.game.getTerrain(ig.game.units[ig.game.activeUnit].pos.x, ig.game.units[ig.game.activeUnit].pos.y);                                        // Step 3. Store terrain bonus for active unit                    ig.game.units[ig.game.activeUnit].terrainMod.avoid += activeUnit_terrain.avoid;                    ig.game.units[ig.game.activeUnit].terrainMod.def += activeUnit_terrain.def;                    // Step 4. Apply the bonuses                    ig.game.units[ig.game.activeUnit].stat.def += ig.game.units[ig.game.activeUnit].terrainMod.def;                    ig.game.units[ig.game.activeUnit].derived_stats.evade += ig.game.units[ig.game.activeUnit].terrainMod.avoid;                    ig.game.units[u].turnUsed = true;                    ig.game.activeUnit = u;                }            }            ig.game.menuVisible = false;            ig.global.killAllButtons(ig.Button);        }    });});